---
layout:     post
title:      "echo框架使用学习总结"
subtitle:   "echo"
data:       ""
author:     ""
header-img: img/echo-back-title.jpg
catalog: true
tags:
    - echo
    - go
---



## 为什么选择echo框架？



## 安装运行

​		（1）使用goland创建一个echodemo的项目的目录

​		（2）执行go mod init echodemo，将会生成go.mod文件

​		（3）创建src目录和main目录，并创建main.go

​		（4）拷贝echo官网的demo到main.go

​		（5）执行go run main.go，在执行过程中会自动下载所依赖的echo包，同时将会更新go.mod和go.sum两个文件 

![echo运行成功](https://github.com/Christian-health/christian-health.github.io/blob/master/img/echo-simple-run.jpg?raw=true)



## 使用echo

#### 1、自定义

echo框架可以自定义如下的内容，有些内容有很长，需要单独的章节来总结。

- 自定义
    - Debug
    - 日志
        - 日志输出 
        - 日志级别
        - 自定义日志
    - 自定义 Server
        - 使用 Echo#StartServer()
        - 启动横幅
        - 自定义监听器
- 禁用 HTTP/2
- 读取超时
- 写入超时
- 验证
- 自定义绑定
- 渲染
- HTTP 错误处理

```go
package main

import (
   "github.com/labstack/gommon/log"
   "io"
   "net/http"
   "os"

   "github.com/labstack/echo/v4"
)

func main() {
   // 创建一个Echo的instance
   e := echo.New()
   /*
     用来关闭启动时候的横幅，也就是在启动的控制台上不要打印出如下内容
     D:\gowork\echo\src\main>go run  main.go

      ____    __
     / __/___/ /  ___
    / _// __/ _ \/ _ \
   /___/\__/_//_/\___/ v4.1.16
   High performance, minimalist Go web framework
   https://echo.labstack.com
   ____________________________________O/_______
                                       O\
   ⇨ http server started on [::]:1323
   */
   e.HideBanner=false

   // 用于关闭HTTP/2协议
   e.DisableHTTP2=true

   //用于设置读取请求的最大时间。

   //用于设置日志输出的位置，默认是 os.Stdout
   e.Logger.SetOutput(io.Writer(os.Stdout))

   //下面两个设置完全禁用日志。
   //e.Logger.SetOutput(ioutil.Discard)
   //e.Logger.SetLevel(log.OFF)

   //设置日志级别
   e.Logger.SetLevel(log.DEBUG)
   //e.Logger.SetLevel(log.INFO)
   //e.Logger.SetLevel(log.WARN)
   //e.Logger.SetLevel(log.ERROR)
   //e.Logger.SetLevel(log.OFF)

   // Routes
   e.GET("/", hello)

   // Start server
   e.Logger.Fatal(e.Start(":1323"))
}

type customerLogger struct {
   Logger echo.Logger
}

// Handler
func hello(c echo.Context) error {
   return c.String(http.StatusOK, "Hello World,customize!")
}	
```

## Context

echo.Context 代表了当前 HTTP 请求的 context（上下文），它含有请求和相应的引用，路径，路径参数，数据，注册的业务处理方法和读取请求和输出响应的API。由于 Context 是一个接口，所以也可以很方便的使用自定义的 API 扩展。
```go
package main

import (
	"net/http"

	"github.com/labstack/echo/v4"
	"github.com/labstack/echo/v4/middleware"
)

/*
	扩展 Context
	定义一个自定义 context
*/
type CustomContext struct {
	echo.Context
}

func (c *CustomContext) Foo() {
	println("foo function run")
}

func (c *CustomContext) Bar() {
	println("bar function run")
}

func main() {
	// Echo instance
	e := echo.New()

	// Middleware
	/*
		创建一个中间件来扩展默认的 context
		此中间件应在任何其他中间件之前注册
	*/
	e.Use(func(next echo.HandlerFunc) echo.HandlerFunc {
		return func(c echo.Context) error {
			println("middleware customcontext run")
			cc := &CustomContext{c}
			return next(cc)
		}
	})

	e.Use(middleware.Logger())
	e.Use(middleware.Recover())

	// Routes
	e.GET("/", hello)

	//在处理器中使用自定义的context
	e.GET("/content", func(c echo.Context) error {
		cc := c.(*CustomContext)
		//cc.Foo()
		//cc.Bar()
		return cc.String(200, "OK")
	})

	// Start server
	e.Logger.Fatal(e.Start(":1323"))
}

// Handler
func hello(c echo.Context) error {
	return c.String(http.StatusOK, "Hello, World!")
}

```
## Cookies
Cookie 是用户访问网站时浏览器上存储的小型文本文件，由服务器发送而来。每当用户加载网站时，浏览器都会将 cookie 发送回服务器以通知用户之前的活动。 Cookie 作为一个可靠验证凭据，可用来记录状态信息（比如在线商城购物车中的商品）或记录用户的浏览器活动（包括单击特定按钮，登录或记录访问过的页面）。Cookie 还可以存储用户先前输入的密码和表单内容，例如信用卡号或地址。

Cookie 属性
|属性 | 可选 |
| -- | -- |
| Name | No |
| Value	| No |
| Path	| Yes |
| Domain | Yes |
| Expires | Yes|
| Secure | Yes |
| HTTPOnly | Yes |

Echo 使用 golang 自带的 http.Cookie 对象写入／读取从上下文中的 cookie。

```go
package main

import (
	"fmt"
	"net/http"
	"time"

	"github.com/labstack/echo/v4"
	"github.com/labstack/echo/v4/middleware"
)

func main() {
	// Echo instance
	e := echo.New()

	// Middleware
	e.Use(middleware.Logger())
	e.Use(middleware.Recover())

	// Routes
	e.GET("/", hello)

	// 写入cookie
	e.GET("/writeCookie", writeCookie)
	// 读取cookie
	e.GET("/readCookie", readCookie)
	// 读取所有的cookie
	e.GET("/readAllCookies", readAllCookies)

	// Start server
	e.Logger.Fatal(e.Start(":1323"))
}

// Handler
func hello(c echo.Context) error {
	return c.String(http.StatusOK, "Hello, World!")
}

/*
写cookie
使用 new(http.Cookie) 创建Cookie。
cookie 的属性值会被赋值给 http.Cookie 的可导出属性。
最后，使用 c.SetCookie(cookies) 来给 HTTP 响应增加 Set-Cookie 头。
*/
func writeCookie(c echo.Context) error {
	cookie := new(http.Cookie)
	cookie.Name = "username"
	cookie.Value = "jon"
	cookie.Expires = time.Now().Add(24 * time.Hour)
	c.SetCookie(cookie)
	return c.String(http.StatusOK, "write a cookie")
}

/*
读cookie
Cookie 通过名称从 HTTP 请求里读取：c.Cookie("name")。
Cookie 的属性可以使用 Getter 方法获取。
*/
func readCookie(c echo.Context) error {
	cookie, err := c.Cookie("username")
	if err != nil {
		return err
	}
	fmt.Println("read cookie Name :", cookie.Name)
	fmt.Println("read cookie Value :", cookie.Value)
	return c.String(http.StatusOK, "read a cookie")
}

// 读取所有的cookie
func readAllCookies(c echo.Context) error {
	for index, cookie := range c.Cookies() {
		fmt.Printf("read all cookie,index is %v Name %s\n", index, cookie.Name)
		fmt.Printf("read all cookie,index is %v Value %s\n", index, cookie.Value)
	}
	return c.String(http.StatusOK, "read all the cookies")
}
/*
[root]$ go run main.go 

   ____    __
  / __/___/ /  ___
 / _// __/ _ \/ _ \
/___/\__/_//_/\___/ v4.1.16
High performance, minimalist Go web framework
https://echo.labstack.com
____________________________________O/_______
                                    O\
⇨ http server started on [::]:1323
read all cookie,index is 0 Name username //读所有的cookie
read all cookie,index is 0 Value jon 
{"time":"2020-07-18T21:23:28.246793142+08:00","id":"","remote_ip":"::1","host":"localhost:1323","method":"GET","uri":"/readAllCookies","user_agent":"Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/79.0.3945.79 Safari/537.36","status":200,"error":"","latency":163405,"latency_human":"163.405µs","bytes_in":0,"bytes_out":20}
read cookie Name : username //读取单个cookie
read cookie Value : jon
{"time":"2020-07-18T21:24:53.078681646+08:00","id":"","remote_ip":"::1","host":"localhost:1323","method":"GET","uri":"/readCookie","user_agent":"Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/79.0.3945.79 Safari/537.36","status":200,"error":"","latency":40588,"latency_human":"40.588µs","bytes_in":0,"bytes_out":13}
*/
```
# 请求

- 请求

  - 数据绑定

    - [JSON 数据](https://www.bookstack.cn/read/echo-v3-zh/guide-request.md#JSON%20%E6%95%B0%E6%8D%AE)
    - [Form 表单数据](https://www.bookstack.cn/read/echo-v3-zh/guide-request.md#Form%20%E8%A1%A8%E5%8D%95%E6%95%B0%E6%8D%AE)
    - [查询参数 (Query Parameters)](https://www.bookstack.cn/read/echo-v3-zh/guide-request.md#%E6%9F%A5%E8%AF%A2%E5%8F%82%E6%95%B0%20(Query%20Parameters))

  - [自定义绑定器](https://www.bookstack.cn/read/echo-v3-zh/guide-request.md#%E8%87%AA%E5%AE%9A%E4%B9%89%E7%BB%91%E5%AE%9A%E5%99%A8)

  - 检索数据

    - [Form 表单数据](https://www.bookstack.cn/read/echo-v3-zh/guide-request.md#Form%20%E8%A1%A8%E5%8D%95%E6%95%B0%E6%8D%AE)
    - [查询参数 (Query Parameters)](https://www.bookstack.cn/read/echo-v3-zh/guide-request.md#%E6%9F%A5%E8%AF%A2%E5%8F%82%E6%95%B0%20(Query%20Parameters))
    - [路径参数 (Path Parameters)](https://www.bookstack.cn/read/echo-v3-zh/guide-request.md#%E8%B7%AF%E5%BE%84%E5%8F%82%E6%95%B0%20(Path%20Parameters))

  - 数据验证
  
### 数据绑定
```go
package main

import (
	"fmt"
	"net/http"

	"github.com/labstack/echo/v4"
	"github.com/labstack/echo/v4/middleware"
)

// User
type User struct {
	Name  string `json:"name" form:"name" query:"name"`
	Email string `json:"email" form:"email" query:"email"`
}

func main() {
	// Echo instance
	e := echo.New()

	// Middleware
	e.Use(middleware.Logger())
	e.Use(middleware.Recover())

	// Routes
	e.GET("/", hello)

	// 测试post绑定
	e.GET("/users", getUsers)

	// 测试post绑定
	e.POST("/users", postUsers)

	// Start server
	e.Logger.Fatal(e.Start(":1323"))
}

// Handler
func hello(c echo.Context) error {
	return c.String(http.StatusOK, "Hello, World!")
}

func getUsers(c echo.Context) (err error) {
	fmt.Println("get to users, getUsers function fun")
	u := new(User)
	if err = c.Bind(u); err != nil {
		return
	}
	return c.JSON(http.StatusOK, u)
}

// Handler
func postUsers(c echo.Context) (err error) {
	fmt.Println("post to users, postUsers function fun")
	u := new(User)
	if err = c.Bind(u); err != nil {
		return
	}
	return c.JSON(http.StatusOK, u)
}
/*
新开一个终端运行如下curl命令：
[root@LIN-6A14041F8B1 src]# curl   -X GET   http://localhost:1323/users\?name\=Joe\&email\=joe@labstack.com
{"name":"Joe","email":"joe@labstack.com"}
[root@LIN-6A14041F8B1 src]# curl -X POST "http://localhost:1323/users" -H "Content-Type: application/json" -d '{"name":"Joe","email":"joe@labstack"}'
{"name":"Joe","email":"joe@labstack"}
[root@LIN-6A14041F8B1 src]# curl -X POST http://localhost:1323/users -d 'name=Joe' -d 'email=joe@labstack.com'
{"name":"Joe","email":"joe@labstack.com"}
[root@LIN-6A14041F8B1 src]# 

Server的终端显示如下结果:
[10200896@zte.intra@LIN-6A14041F8B1 main]$ go run main.go 

   ____    __
  / __/___/ /  ___
 / _// __/ _ \/ _ \
/___/\__/_//_/\___/ v4.1.16
High performance, minimalist Go web framework
https://echo.labstack.com
____________________________________O/_______
                                    O\
⇨ http server started on [::]:1323
get to users, getUsers function fun
{"time":"2020-07-19T09:25:27.822184902+08:00","id":"","remote_ip":"127.0.0.1","host":"localhost:1323","method":"GET","uri":"/users?name=Joe&email=joe@labstack.com","user_agent":"curl/7.51.0","status":200,"error":"","latency":189588,"latency_human":"189.588µs","bytes_in":0,"bytes_out":42}
post to users, postUsers function fun
{"time":"2020-07-19T09:25:34.163877389+08:00","id":"","remote_ip":"127.0.0.1","host":"localhost:1323","method":"POST","uri":"/users","user_agent":"curl/7.51.0","status":200,"error":"","latency":104889,"latency_human":"104.889µs","bytes_in":37,"bytes_out":38}
post to users, postUsers function fun
{"time":"2020-07-19T09:25:37.913292269+08:00","id":"","remote_ip":"127.0.0.1","host":"localhost:1323","method":"POST","uri":"/users","user_agent":"curl/7.51.0","status":200,"error":"","latency":126059,"latency_human":"126.059µs","bytes_in":31,"bytes_out":42}

*/
```
### 自定义绑定器
```go
//服务端代码
package main

import (
	"fmt"
	"net/http"
	"strings"

	"github.com/labstack/echo/v4"
	"github.com/labstack/echo/v4/middleware"
	"github.com/vmihailenco/msgpack"
)

type User struct {
	Name string `json:"name"`
	Sex  string `json:"sex"`
}

type MsgpackBinder struct{}

func (b *MsgpackBinder) Bind(i interface{}, ctx echo.Context) (err error) {
	fmt.Println("MsgpackBinder Bind run before echo DefaultBinder")
	// 也支持默认 Binder 相关的绑定
	db := new(echo.DefaultBinder)
	if err = db.Bind(i, ctx); err != echo.ErrUnsupportedMediaType {
		return
	}
	fmt.Println("MsgpackBinder Bind run after echo DefaultBinder")
	req := ctx.Request()
	ctype := req.Header.Get(echo.HeaderContentType)
	if strings.HasPrefix(ctype, echo.MIMEApplicationMsgpack) {
		if err = msgpack.NewDecoder(req.Body).Decode(i); err != nil {
			return echo.NewHTTPError(http.StatusBadRequest, err.Error()).SetInternal(err)
		}
		fmt.Println("MsgpackBinder Bind run before MsgpackBinder return")
		return
	}

	return echo.ErrUnsupportedMediaType
}

func main() {
	// Echo instance
	e := echo.New()
	e.Binder = new(MsgpackBinder)

	// Middleware
	e.Use(middleware.Logger())
	e.Use(middleware.Recover())

	// Routes
	e.GET("/", helloGet)
	e.POST("/", helloPost)

	// Start server
	e.Logger.Fatal(e.Start(":1323"))
}

// Handler
func helloPost(c echo.Context) (err error) {
	fmt.Println("post to users, postUsers function fun")
	u := new(User)
	if err = c.Bind(u); err != nil {
		return
	}
	return c.JSON(http.StatusOK, u)
}

func helloGet(c echo.Context) error {
	fmt.Println("get to users, getUsers function fun")
	return c.String(http.StatusOK, "Hello, world hello Get!")
}
/*运行结果
[root]$ go run main.go 

   ____    __
  / __/___/ /  ___
 / _// __/ _ \/ _ \
/___/\__/_//_/\___/ v4.1.16
High performance, minimalist Go web framework
https://echo.labstack.com
____________________________________O/_______
                                    O\
⇨ http server started on [::]:1323
post to users, postUsers function fun
MsgpackBinder Bind run before echo DefaultBinder
MsgpackBinder Bind run after echo DefaultBinder
MsgpackBinder Bind run before MsgpackBinder return
{"time":"2020-07-19T13:57:52.302913939+08:00","id":"","remote_ip":"127.0.0.1","host":"localhost:1323","method":"POST","uri":"/","user_agent":"Go-http-client/1.1","status":200,"error":"","latency":229598,"latency_human":"229.598µs","bytes_in":24,"bytes_out":33}

*/

```
```go
客户端代码
package main

import (
    "bytes"
    "fmt"
    "io/ioutil"
    "net/http"

    "github.com/vmihailenco/msgpack"
)

func main() {
    type User struct {
        Name string
        Sex  string
    }

    b, err := msgpack.Marshal(&User{Name: "tom", Sex: "male"})
    if err != nil {
        panic(err)
    }

    resp, err := http.DefaultClient.Post("http://localhost:1323/", "application/msgpack", bytes.NewReader(b))
    if err != nil {
        panic(err)
    }
    defer resp.Body.Close()

    result, err := ioutil.ReadAll(resp.Body)
    if err != nil {
        panic(err)
    }

    fmt.Printf("%s\n", result)
}
/*
运行结果
[root]$ go run main.go 
{"name":"tom","sex":"male"}
*/
```
### 数据验证

### 路径参数 (Path Parameters)

### 查询参数 (Query Parameters)

### Form 表单数据

```go
package main

import (
	"net/http"

	"github.com/go-playground/validator/v10"
	"github.com/labstack/echo/v4"
	"github.com/labstack/echo/v4/middleware"
)

type (
	User struct {
		Name  string `json:"name" validate:"required"`
		Email string `json:"email" validate:"required,email"`
	}
	CustomValidator struct {
		validator *validator.Validate
	}
)

func (cv *CustomValidator) Validate(i interface{}) error {
	return cv.validator.Struct(i)
}

func main() {
	// Echo instance
	e := echo.New()
	e.Validator = &CustomValidator{validator: validator.New()}

	// Middleware
	e.Use(middleware.Logger())
	e.Use(middleware.Recover())

	// Routes
	e.GET("/", hello)

	e.POST("/postName", FormNameValue)

	e.GET("/getName", queryName)

	// 路径参数 (Path Parameters)
	e.GET("/users/:name", func(c echo.Context) error {
		name := c.Param("name")
		return c.String(http.StatusOK, "Path Parameters : "+name)
	})

	e.POST("/users", func(c echo.Context) (err error) {
		u := new(User)
		if err = c.Bind(u); err != nil {
			return
		}
		if err = c.Validate(u); err != nil {
			return
		}
		return c.JSON(http.StatusOK, u)
	})

	// Start server
	e.Logger.Fatal(e.Start(":1323"))
}

// Handler
func hello(c echo.Context) error {
	return c.String(http.StatusOK, "Hello, World!")
}

/*
Form 表单数据
curl -X POST http://localhost:1323/postName -d 'name=Joe'
运行上面curl命令返回结果:Joe
*/
func FormNameValue(c echo.Context) error {
	name := c.FormValue("name")
	return c.String(http.StatusOK, "FormNameValue : "+name)
}

// 查询参数 (Query Parameters)
func queryName(c echo.Context) error {
	name := c.QueryParam("name")
	return c.String(http.StatusOK, "queryName : "+name)
}

```

##  响应

 响应

- [发送 string 数据](https://www.bookstack.cn/read/echo-v3-zh/guide-response.md#%E5%8F%91%E9%80%81%20string%20%E6%95%B0%E6%8D%AE)
- 发送 HTML 响应 (参考模板)
  - [发送 HTML Blob](https://www.bookstack.cn/read/echo-v3-zh/guide-response.md#%E5%8F%91%E9%80%81%20HTML%20Blob)
- [模版引擎渲染](https://www.bookstack.cn/read/echo-v3-zh/guide-response.md#%E6%A8%A1%E7%89%88%E5%BC%95%E6%93%8E%E6%B8%B2%E6%9F%93)
- 发送 JSON 数据
  - [JSON 流](https://www.bookstack.cn/read/echo-v3-zh/guide-response.md#JSON%20%E6%B5%81)
  - [JSON 美化 (JSON Pretty)](https://www.bookstack.cn/read/echo-v3-zh/guide-response.md#JSON%20%E7%BE%8E%E5%8C%96%20(JSON%20Pretty))
  - [JSON Blob](https://www.bookstack.cn/read/echo-v3-zh/guide-response.md#JSON%20Blob)
- [发送 JSONP 数据](https://www.bookstack.cn/read/echo-v3-zh/guide-response.md#%E5%8F%91%E9%80%81%20JSONP%20%E6%95%B0%E6%8D%AE)
- 发送 XML 数据
  - [XML 流](https://www.bookstack.cn/read/echo-v3-zh/guide-response.md#XML%20%E6%B5%81)
  - [XML 美化 (XML Pretty)](https://www.bookstack.cn/read/echo-v3-zh/guide-response.md#XML%20%E7%BE%8E%E5%8C%96%20(XML%20Pretty))
  - [XML Blob](https://www.bookstack.cn/read/echo-v3-zh/guide-response.md#XML%20Blob)
- [发送文件](https://www.bookstack.cn/read/echo-v3-zh/guide-response.md#%E5%8F%91%E9%80%81%E6%96%87%E4%BB%B6)
- [发送附件](https://www.bookstack.cn/read/echo-v3-zh/guide-response.md#%E5%8F%91%E9%80%81%E9%99%84%E4%BB%B6)
- [发送内嵌 (Inline)](https://www.bookstack.cn/read/echo-v3-zh/guide-response.md#%E5%8F%91%E9%80%81%E5%86%85%E5%B5%8C%20(Inline))
- [发送二进制长文件 (Blob)](https://www.bookstack.cn/read/echo-v3-zh/guide-response.md#%E5%8F%91%E9%80%81%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%95%BF%E6%96%87%E4%BB%B6%20(Blob))
- [发送流 (Stream)](https://www.bookstack.cn/read/echo-v3-zh/guide-response.md#%E5%8F%91%E9%80%81%E6%B5%81%20(Stream))
- [发送空内容 (No Content)](https://www.bookstack.cn/read/echo-v3-zh/guide-response.md#%E5%8F%91%E9%80%81%E7%A9%BA%E5%86%85%E5%AE%B9%20(No%20Content))
- [重定向](https://www.bookstack.cn/read/echo-v3-zh/guide-response.md#%E9%87%8D%E5%AE%9A%E5%90%91)
- Hooks
  - [响应之前](https://www.bookstack.cn/read/echo-v3-zh/guide-response.md#%E5%93%8D%E5%BA%94%E4%B9%8B%E5%89%8D)
  - [响应之后](https://www.bookstack.cn/read/echo-v3-zh/guide-response.md#%E5%93%8D%E5%BA%94%E4%B9%8B%E5%90%8E)


## 参考：

- [echo英文官方文档](https://echo.labstack.com/guide )
- [echo中文文档](https://www.bookstack.cn/read/go-echo/README.md)
- [ECHO系列教程](http://blog.studygolang.com/category/echo-%e7%b3%bb%e5%88%97/)
- [ECHO v3教程](https://www.bookstack.cn/read/echo-v3-zh/README.md)
- [tizi365的echo教程](https://www.tizi365.com/archives/28.html)
- [邱权武的echo教程](https://www.yuque.com/qiuquanwu/lz8ker/trglbn)
- [徐新华echo教程](http://blog.studygolang.com/)
